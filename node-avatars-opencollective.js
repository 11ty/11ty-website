const slugify = require("slugify");
const fs = require("fs-extra");
const eleventyImg = require("@11ty/eleventy-img");

eleventyImg.concurrency = 5;

async function fetch(name, imageUrl, website) {
	if(!name) {
		return;
	}
	if(!imageUrl && !website) {
		return;
	}
	// TODO bail if the website pathname is a deep path?

	let dir = `./avatars/opencollective/`;
	await fs.ensureDir(dir);

	// if website exists but no avatar image exists, try to find based on website hostname
	if(!imageUrl && website) {
		let websiteUrl = new URL(website);
		imageUrl = `https://unavatar.now.sh/${websiteUrl.hostname}?fallback=false`;
	}

	let stats = await eleventyImg(imageUrl, {
		// formats: ["webp", "jpeg"],
		formats: ["jpeg"],
		widths: [90],
		urlPath: "/img/avatars/opencollective/",
		outputDir: "img/avatars/opencollective/",
		cacheOptions: {
			duration: "1d",
		}
	});

	let slug = slugify(name).toLowerCase();
	let path = `${dir}${slug}.json`;
	stats.slug = slug;
	await fs.writeFile(path, JSON.stringify(stats, null, 2));
	return stats;
}

(async function() {
	let promises = [];
	let redirects = [
		"# Careful! This file is generated by node-avatars-opencollective.js for runtime JS for Eleventy Contributor Account avatars",
		"# You can add manual entries to the netlify.toml file",
	];

	let getOpenCollectiveData = require("./_data/opencollective");
	let opencollective = await getOpenCollectiveData();
	for(let supporter of opencollective.supporters) {
		// / https://levelup-styleguide.netlify.com/ 200!
		promises.push(fetch(supporter.name, supporter.image, supporter.website));
	}

	let all = await Promise.all(promises);
	for(let stats of all) {
		if(stats) {
			redirects.push(`/img/avatars/opencollective/${stats.slug}.jpg ${stats.jpeg[0].url} 200!`);
		}
	}
	await fs.writeFile("./_redirects", redirects.join("\n"));
})();
